name: Aliyun1.0.5

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  buildx:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # æ·»åŠ è¶…æ—¶è®¾ç½®
    
    env:
      VERSION: v1.0.5
      ALIYUN_REGISTRY: crpi-x68pqc6t5zexwzms.cn-guangzhou.personal.cr.aliyuncs.com
      FULL_IMAGE_NAME: crpi-x68pqc6t5zexwzms.cn-guangzhou.personal.cr.aliyuncs.com/xianyuauto/xianyu
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Debug - Show image info
        run: |
          echo "Registry: ${{ env.ALIYUN_REGISTRY }}"
          echo "Full Image Name: ${{ env.FULL_IMAGE_NAME }}"
          echo "Version: ${{ env.VERSION }}"
          
      - name: Setup QEMU (for multi-arch builds)
        uses: docker/setup-qemu-action@v3
        
      - name: Login to Aliyun Personal Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}
          
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        id: buildx
        with:
          driver: docker-container
          driver-opts: |
            image=moby/buildkit:master
          buildkitd-flags: --debug
          
      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-
            
      - name: Build and push with retry logic
        run: |
          set -e  # å‡ºé”™æ—¶é€€å‡º
          
          # æ„å»ºå¹¶æ¨é€å¤šæ¶æ„é•œåƒï¼Œæ·»åŠ é‡è¯•æœºåˆ¶
          max_retries=3
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            echo "å°è¯•ç¬¬ $((retry_count + 1)) æ¬¡æ„å»ºå’Œæ¨é€..."
            
            # ä½¿ç”¨æ„å»ºç¼“å­˜ï¼Œç¦ç”¨è¯æ˜ä»¥åŠ é€Ÿ
            docker buildx build \
              --platform linux/amd64,linux/arm64 \
              -t ${{ env.FULL_IMAGE_NAME }}:${{ env.VERSION }} \
              -t ${{ env.FULL_IMAGE_NAME }}:latest \
              -f Dockerfile . \
              --push \
              --cache-from type=gha \
              --cache-to type=gha,mode=max \
              --provenance=false \
              --no-cache-filter="provenance" \
              --builder=default \
              && {
                echo "æ„å»ºå’Œæ¨é€æˆåŠŸï¼"
                break
              }
              
            retry_count=$((retry_count + 1))
            if [ $retry_count -lt $max_retries ]; then
              echo "æ¨é€å¤±è´¥ï¼Œç­‰å¾… 30 ç§’åé‡è¯•..."
              sleep 30
            else
              echo "å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° $max_retriesï¼Œæ„å»ºå¤±è´¥"
              exit 1
            fi
          done
          
      - name: å•ç‹¬æ¨é€æ¯ä¸ªæ ‡ç­¾ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        if: failure()  # åªåœ¨ä¸»æ­¥éª¤å¤±è´¥æ—¶æ‰§è¡Œ
        run: |
          echo "ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆï¼šå…ˆæ„å»ºåæ¨é€..."
          
          # 1. å…ˆæ„å»ºåˆ°æœ¬åœ°
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t ${{ env.FULL_IMAGE_NAME }}:${{ env.VERSION }} \
            --output type=docker,dest=/tmp/image.tar \
            --provenance=false \
            .
            
          # 2. åŠ è½½é•œåƒ
          docker load < /tmp/image.tar
          
          # 3. åˆ†åˆ«æ¨é€æ¯ä¸ªæ¶æ„ï¼ˆå¯é€‰ï¼Œå¦‚æœå¤šæ¶æ„å¤±è´¥ï¼‰
          # æ¨é€ç‰ˆæœ¬æ ‡ç­¾
          for i in {1..3}; do
            echo "ç¬¬ $i æ¬¡å°è¯•æ¨é€ ${{ env.VERSION }} æ ‡ç­¾..."
            docker push ${{ env.FULL_IMAGE_NAME }}:${{ env.VERSION }} && break || sleep 15
          done
          
          # 4. æ¨é€ latest æ ‡ç­¾
          docker tag ${{ env.FULL_IMAGE_NAME }}:${{ env.VERSION }} ${{ env.FULL_IMAGE_NAME }}:latest
          for i in {1..3}; do
            echo "ç¬¬ $i æ¬¡å°è¯•æ¨é€ latest æ ‡ç­¾..."
            docker push ${{ env.FULL_IMAGE_NAME }}:latest && break || sleep 15
          done
          
      - name: æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼ˆè°ƒè¯•ç”¨ï¼‰
        if: failure()
        run: |
          echo "=== ç½‘ç»œè¯Šæ–­ ==="
          ping -c 3 8.134.224.193 || true
          curl -I https://${{ env.ALIYUN_REGISTRY }}/v2/ || true
          echo "=== Docker ä¿¡æ¯ ==="
          docker info | grep -A5 "Registry"
          echo "=== é•œåƒåˆ—è¡¨ ==="
          docker images | grep xianyu || true
          
      - name: Verify image pushed successfully
        run: |
          echo "âœ… æ„å»ºå®Œæˆï¼"
          echo "ğŸ“¦ é•œåƒåœ°å€: ${{ env.FULL_IMAGE_NAME }}:${{ env.VERSION }}"
          echo "ğŸ·ï¸  æœ€æ–°æ ‡ç­¾: ${{ env.FULL_IMAGE_NAME }}:latest"
          echo ""
          echo "æ‚¨å¯ä»¥åœ¨é˜¿é‡Œäº‘æ§åˆ¶å°æŸ¥çœ‹ï¼š"
          echo "https://cr.console.aliyun.com/cn-guangzhou/instances"
          
      - name: æ¸…ç† Docker èµ„æºï¼ˆå¯é€‰ï¼‰
        if: always()
        run: |
          echo "æ¸…ç† Docker èµ„æº..."
          docker system prune -f || true
          docker builder prune -f || true
