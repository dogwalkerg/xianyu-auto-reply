name: Sync & Build Multi-Arch

on:
  workflow_dispatch:
    inputs:
      force_build:
        description: 'å¼ºåˆ¶æ„å»ºé•œåƒ'
        required: false
        type: boolean
        default: false
      version_tag:
        description: 'è‡ªå®šä¹‰ç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¦‚ï¼šv1.0.0ï¼‰'
        required: false
        default: ''
  schedule:
    - cron: '0 3 * * *'
    - cron: '0 10 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.changes_detected || inputs.force_build }}
      build_date: ${{ steps.date.outputs.date }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@users.noreply.github.com"

      - name: Get current date
        id: date
        run: |
          echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
          echo "datetime=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Sync Upstream
        id: check
        run: |
          git remote add upstream https://github.com/zhinianboke/xianyu-auto-reply.git || true
          git fetch upstream
          
          if [ "${{ github.event.inputs.force_build }}" = "true" ] || [ -n "${{ github.event.inputs.version_tag }}" ]; then
            echo "ğŸŸ¡ æ‰‹åŠ¨è§¦å‘æ„å»ºæ¨¡å¼"
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          elif ! git diff --quiet HEAD upstream/main; then
            echo "ğŸ”µ æ£€æµ‹åˆ°ä¸Šæ¸¸å˜æ›´"
            git merge -X theirs upstream/main
            git push origin main
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸŸ¢ æ— æ–°å˜æ›´"
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi

  build-multi-arch:
    needs: sync
    if: needs.sync.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 45  # å¤šæ¶æ„æ„å»ºéœ€è¦æ›´é•¿æ—¶é—´
    
    env:
      DOCKER_USERNAME: "bbrplus"
      IMAGE_NAME: "xianyu-auto-reply"
      VERSION_TAG: ${{ github.event.inputs.version_tag || 'latest' }}
      DATE_TAG: ${{ needs.sync.outputs.date || 'nodate' }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show build info
        run: |
          echo "ğŸ¯ å¤šæ¶æ„æ„å»ºé…ç½®ï¼š"
          echo "Docker Hub ç”¨æˆ·å: ${{ env.DOCKER_USERNAME }}"
          echo "é•œåƒåç§°: ${{ env.IMAGE_NAME }}"
          echo "ç‰ˆæœ¬æ ‡ç­¾: ${{ env.VERSION_TAG }}"
          echo "æ„å»ºæ—¥æœŸ: ${{ env.DATE_TAG }}"
          echo "æ”¯æŒæ¶æ„: linux/amd64, linux/arm64"
          echo "Git SHA: ${{ github.sha }}"
          echo ""
          echo "ğŸ“Š Docker Hub ä»“åº“:"
          echo "https://hub.docker.com/r/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}"

      - name: Set up QEMU for ARM64 emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64  # å¯ç”¨ ARM64 æ¨¡æ‹Ÿ

      - name: Create and use Buildx builder
        run: |
          # åˆ›å»ºæ”¯æŒå¤šæ¶æ„çš„ builder
          docker buildx create \
            --name multi-arch-builder \
            --driver docker-container \
            --driver-opt network=host \
            --platform linux/amd64,linux/arm64 \
            --use
          
          # å¯åŠ¨å¹¶æ£€æŸ¥ builder
          docker buildx inspect --bootstrap
          
          # æ˜¾ç¤ºæ”¯æŒçš„å¹³å°
          echo "âœ… Builder æ”¯æŒçš„å¹³å°:"
          docker buildx ls

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and push multi-arch image
        uses: docker/build-push-action@v5
        id: build-push
        with:
          context: .
          platforms: linux/amd64,linux/arm64  # åŒæ—¶æ„å»ºä¸¤ä¸ªæ¶æ„
          push: true
          tags: |
            # ä¸»è¦æ ‡ç­¾ï¼ˆå¤šæ¶æ„ï¼‰
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:v1.0.4
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.DATE_TAG }}
            
            # æäº¤ç‰ˆæœ¬æ ‡ç­¾
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            
            # æ¶æ„ç‰¹å®šæ ‡ç­¾ï¼ˆå¯é€‰ï¼Œç”¨äºè°ƒè¯•ï¼‰
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.DATE_TAG }}-amd64
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.DATE_TAG }}-arm64
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            org.opencontainers.image.version=v1.0.4
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NPM_REGISTRY=https://registry.npmmirror.com
            PNPM_FLAGS=--store-dir=/tmp/pnpm-store
            VERSION=v1.0.4
          provenance: false
          sbom: false

      - name: Verify multi-arch manifest
        run: |
          echo "ğŸ” éªŒè¯å¤šæ¶æ„é•œåƒæ¸…å•..."
          sleep 5  # ç­‰å¾… Docker Hub å¤„ç†
          
          echo ""
          echo "æ£€æŸ¥ latest æ ‡ç­¾çš„æ¶æ„æ”¯æŒ:"
          docker buildx imagetools inspect ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest || \
          echo "æ³¨æ„: å¯èƒ½éœ€è¦å…ˆç™»å½•æ‰èƒ½æŸ¥çœ‹"
          
          echo ""
          echo "ğŸ“Š é•œåƒæ¶æ„ä¿¡æ¯:"
          echo "é•œåƒå·²æ”¯æŒä»¥ä¸‹æ¶æ„:"
          echo "  - linux/amd64 (x86_64, Intel/AMD æœåŠ¡å™¨å’ŒPC)"
          echo "  - linux/arm64 (ARM64, Apple Silicon, Raspberry Pi 4, ARMæœåŠ¡å™¨)"
          echo ""
          echo "âœ… Docker ä¼šè‡ªåŠ¨æ ¹æ®è¿è¡Œå¹³å°æ‹‰å–æ­£ç¡®çš„æ¶æ„"

      - name: Test pulling different architectures
        run: |
          echo "ğŸ§ª æµ‹è¯•ä¸åŒæ¶æ„çš„æ‹‰å–:"
          echo ""
          echo "å¯¹äº AMD64/x86_64 ç³»ç»Ÿ:"
          echo "  docker pull --platform linux/amd64 ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "å¯¹äº ARM64 ç³»ç»Ÿ (Apple Silicon Mac, Raspberry Pi):"
          echo "  docker pull --platform linux/arm64 ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "è‡ªåŠ¨é€‰æ‹© (Docker ä¼šæ ¹æ®å½“å‰ç³»ç»Ÿé€‰æ‹©):"
          echo "  docker pull ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest"

      - name: Clean up builder
        if: always()
        run: |
          echo "æ¸…ç† Buildx builder..."
          docker buildx rm multi-arch-builder || true

      - name: Display completion info
        run: |
          echo "=========================================="
          echo "âœ… å¤šæ¶æ„ Docker é•œåƒæ„å»ºå®Œæˆï¼"
          echo ""
          echo "ğŸ“¦ é•œåƒä¿¡æ¯:"
          echo "   åç§°: ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}"
          echo "   ç‰ˆæœ¬: v1.0.4"
          echo "   æ¶æ„: linux/amd64 + linux/arm64"
          echo ""
          echo "ğŸ·ï¸  å¯ç”¨æ ‡ç­¾:"
          echo "   â€¢ latest (å¤šæ¶æ„)"
          echo "   â€¢ v1.0.4 (å¤šæ¶æ„)"
          echo "   â€¢ ${{ env.DATE_TAG }} (å¤šæ¶æ„)"
          echo "   â€¢ ${{ github.sha }} (å¤šæ¶æ„)"
          echo "   â€¢ ${{ env.DATE_TAG }}-amd64 (ä»… AMD64)"
          echo "   â€¢ ${{ env.DATE_TAG }}-arm64 (ä»… ARM64)"
          echo ""
          echo "ğŸ—ï¸  æ”¯æŒçš„å¹³å°:"
          echo "   â€¢ Intel/AMD æœåŠ¡å™¨ (x86_64)"
          echo "   â€¢ Apple Silicon Mac (M1/M2/M3)"
          echo "   â€¢ Raspberry Pi 4/5 (ARM64)"
          echo "   â€¢ AWS Graviton/ARM æœåŠ¡å™¨"
          echo ""
          echo "ğŸŒ æŸ¥çœ‹ Docker Hub:"
          echo "   https://hub.docker.com/r/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}/tags"
          echo ""
          echo "ğŸ” éªŒè¯å‘½ä»¤:"
          echo "   # æŸ¥çœ‹é•œåƒæ”¯æŒçš„æ¶æ„"
          echo "   docker manifest inspect ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "   # æ‹‰å–ç‰¹å®šæ¶æ„"
          echo "   docker pull --platform linux/arm64 ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
          echo "=========================================="

  # å¯é€‰ï¼šæ·»åŠ å•æ¶æ„æ„å»ºä½œä¸ºå›é€€æ–¹æ¡ˆ
  build-fallback:
    needs: [sync, build-multi-arch]
    if: needs.build-multi-arch.result == 'failure'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      DOCKER_USERNAME: "bbrplus"
      IMAGE_NAME: "xianyu-auto-reply"
    
    steps:
      - uses: actions/checkout@v4
        
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
          
      - name: Build and push amd64 only
        run: |
          echo "âš ï¸ å¤šæ¶æ„æ„å»ºå¤±è´¥ï¼Œå›é€€åˆ°å•æ¶æ„ (amd64)"
          
          docker build \
            -t ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest \
            -t ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:v1.0.4-amd64 \
            -f Dockerfile .
            
          docker push ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:v1.0.4-amd64
          
          echo "âœ… å•æ¶æ„é•œåƒå·²æ¨é€"
