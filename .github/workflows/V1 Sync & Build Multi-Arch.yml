name: V1 Sync & Build Multi-Arch

on:
  workflow_dispatch:
    inputs:
      force_build:
        description: 'å¼ºåˆ¶æ„å»ºé•œåƒ'
        required: false
        type: boolean
        default: false
      version_tag:
        description: 'è‡ªå®šä¹‰ç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¦‚ï¼šv1.0.5ï¼‰'
        required: false
        default: 'v1.0.5'
  schedule:
    - cron: '0 3 * * *'
    - cron: '0 10 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.changes_detected || inputs.force_build }}
      build_date: ${{ steps.date.outputs.date }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@users.noreply.github.com"

      - name: Get current date and version
        id: date
        run: |
          echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
          echo "datetime=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          
          # è‡ªåŠ¨æ£€æµ‹ç‰ˆæœ¬å·
          if [ -f "package.json" ]; then
            VERSION=$(grep -o '"version": "[^"]*"' package.json | cut -d'"' -f4)
            echo "version=${VERSION:-v1.0.5}" >> $GITHUB_OUTPUT
          else
            echo "version=v1.0.5" >> $GITHUB_OUTPUT
          fi

      - name: Sync Upstream
        id: check
        run: |
          git remote add upstream https://github.com/zhinianboke/xianyu-auto-reply.git || true
          git fetch upstream
          
          if [ "${{ github.event.inputs.force_build }}" = "true" ] || [ -n "${{ github.event.inputs.version_tag }}" ]; then
            echo "ğŸŸ¡ æ‰‹åŠ¨è§¦å‘æ„å»ºæ¨¡å¼"
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          elif ! git diff --quiet HEAD upstream/main; then
            echo "ğŸ”µ æ£€æµ‹åˆ°ä¸Šæ¸¸å˜æ›´"
            git merge -X theirs upstream/main
            git push origin main
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸŸ¢ æ— æ–°å˜æ›´"
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi

  build-multi-arch:
    needs: sync
    if: needs.sync.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    env:
      DOCKER_USERNAME: "bbrplus"
      IMAGE_NAME: "xianyu-auto-reply"
      # ä½¿ç”¨è¾“å…¥çš„ç‰ˆæœ¬æ ‡ç­¾æˆ–è‡ªåŠ¨æ£€æµ‹çš„ç‰ˆæœ¬
      VERSION_TAG: ${{ github.event.inputs.version_tag || needs.sync.outputs.version || 'v1.0.5' }}
      DATE_TAG: ${{ needs.sync.outputs.date || format(time(format(time(), 'yyyy-MM-dd')), 'yyyyMMdd') }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show build info
        run: |
          echo "ğŸ¯ å¤šæ¶æ„æ„å»ºé…ç½®ï¼š"
          echo "Docker Hub ç”¨æˆ·å: ${{ env.DOCKER_USERNAME }}"
          echo "é•œåƒåç§°: ${{ env.IMAGE_NAME }}"
          echo "ç‰ˆæœ¬æ ‡ç­¾: ${{ env.VERSION_TAG }}"
          echo "æ„å»ºæ—¥æœŸ: ${{ env.DATE_TAG }}"
          echo "Git æäº¤: ${{ github.sha }}"
          echo "æ”¯æŒæ¶æ„: linux/amd64, linux/arm64"
          echo ""
          echo "ğŸ“Š Docker Hub ä»“åº“:"
          echo "https://hub.docker.com/r/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}"

      - name: Set up QEMU for ARM64 emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Create and use Buildx builder
        run: |
          # åˆ›å»ºæ”¯æŒå¤šæ¶æ„çš„ builder
          docker buildx create \
            --name multi-arch-builder \
            --driver docker-container \
            --driver-opt network=host \
            --platform linux/amd64,linux/arm64 \
            --use
          
          # å¯åŠ¨å¹¶æ£€æŸ¥ builder
          docker buildx inspect --bootstrap

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and push multi-arch image
        uses: docker/build-push-action@v5
        id: build-push
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            # ä¸»è¦ç‰ˆæœ¬æ ‡ç­¾
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.VERSION_TAG }}
            
            # å¸¦æ—¥æœŸçš„ç‰ˆæœ¬æ ‡ç­¾
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.VERSION_TAG }}-${{ env.DATE_TAG }}
            
            # Git æäº¤æ ‡ç­¾
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            
            # æ¶æ„ç‰¹å®šæ ‡ç­¾ï¼ˆå¯é€‰ï¼‰
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.VERSION_TAG }}-${{ env.DATE_TAG }}-amd64
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.VERSION_TAG }}-${{ env.DATE_TAG }}-arm64
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            org.opencontainers.image.version=${{ env.VERSION_TAG }}
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NPM_REGISTRY=https://registry.npmmirror.com
            PNPM_FLAGS=--store-dir=/tmp/pnpm-store
            VERSION=${{ env.VERSION_TAG }}
          provenance: false
          sbom: false

      - name: Verify image tags
        run: |
          echo "ğŸ” éªŒè¯é•œåƒæ ‡ç­¾æ˜¯å¦æ¨é€æˆåŠŸ..."
          sleep 5
          
          echo ""
          echo "âœ… ä»¥ä¸‹æ ‡ç­¾åº”è¯¥å·²ç»æ¨é€åˆ° Docker Hubï¼š"
          echo ""
          echo "1. åŸºç¡€æ ‡ç­¾ï¼š"
          echo "   docker pull ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
          echo "   docker pull ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.VERSION_TAG }}"
          echo ""
          echo "2. å¸¦æ—¥æœŸæ ‡ç­¾ï¼š"
          echo "   docker pull ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.VERSION_TAG }}-${{ env.DATE_TAG }}"
          echo ""
          echo "3. Git æäº¤æ ‡ç­¾ï¼š"
          echo "   docker pull ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo ""
          echo "4. æ¶æ„ç‰¹å®šæ ‡ç­¾ï¼š"
          echo "   docker pull ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.VERSION_TAG }}-${{ env.DATE_TAG }}-amd64"
          echo "   docker pull ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.VERSION_TAG }}-${{ env.DATE_TAG }}-arm64"

      - name: Clean up builder
        if: always()
        run: |
          echo "æ¸…ç† Buildx builder..."
          docker buildx rm multi-arch-builder || true

      - name: Display completion info
        run: |
          echo "=========================================="
          echo "âœ… å¤šæ¶æ„ Docker é•œåƒæ„å»ºå®Œæˆï¼"
          echo ""
          echo "ğŸ“¦ é•œåƒä¿¡æ¯ï¼š"
          echo "   ä»“åº“ï¼š${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}"
          echo "   ç‰ˆæœ¬ï¼š${{ env.VERSION_TAG }}"
          echo "   æ—¥æœŸï¼š${{ env.DATE_TAG }}"
          echo "   æ¶æ„ï¼šlinux/amd64 + linux/arm64"
          echo ""
          echo "ğŸ·ï¸  æ¨èä½¿ç”¨çš„æ ‡ç­¾ï¼š"
          echo "   â€¢ ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
          echo "   â€¢ ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.VERSION_TAG }}"
          echo ""
          echo "ğŸ”— Docker Hub é“¾æ¥ï¼š"
          echo "   https://hub.docker.com/r/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}/tags"
          echo ""
          echo "ğŸš€ ä½¿ç”¨å‘½ä»¤ï¼š"
          echo "   # æ‹‰å–æœ€æ–°ç‰ˆæœ¬"
          echo "   docker pull ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.VERSION_TAG }}"
          echo ""
          echo "   # éªŒè¯å¤šæ¶æ„æ”¯æŒ"
          echo "   docker manifest inspect ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.VERSION_TAG }}"
          echo "=========================================="
