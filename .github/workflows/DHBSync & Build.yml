name: DHBSync & Build

on:
  workflow_dispatch:
    inputs:
      force_build:
        description: 'å¼ºåˆ¶æ„å»ºé•œåƒ'
        required: false
        type: boolean
        default: false
  schedule:
    - cron: '0 3 * * *'
    - cron: '0 10 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.changes_detected || inputs.force_build }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@users.noreply.github.com"

      - name: Sync Upstream
        id: check
        run: |
          git remote add upstream https://github.com/zhinianboke/xianyu-auto-reply.git || true
          git fetch upstream
          
          if [ "${{ github.event.inputs.force_build }}" = "true" ]; then
            echo "ğŸŸ¡ æ‰‹åŠ¨è§¦å‘æ„å»ºæ¨¡å¼"
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          elif ! git diff --quiet HEAD upstream/main; then
            echo "ğŸ”µ æ£€æµ‹åˆ°ä¸Šæ¸¸å˜æ›´"
            git merge -X theirs upstream/main
            git push origin main
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸŸ¢ æ— æ–°å˜æ›´"
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi

  build:
    needs: sync
    if: needs.sync.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      DOCKER_USERNAME: "bbrplus"  # ä½ çš„ Docker Hub ç”¨æˆ·å
      IMAGE_NAME: "xianyu-auto-reply"
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show build info
        run: |
          echo "ğŸ¯ æ„å»ºé…ç½®ä¿¡æ¯ï¼š"
          echo "Docker Hub ç”¨æˆ·å: ${{ env.DOCKER_USERNAME }}"
          echo "é•œåƒåç§°: ${{ env.IMAGE_NAME }}"
          echo "å®Œæ•´é•œåƒåœ°å€: ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}"
          echo ""
          echo "ğŸ“Š éªŒè¯ Docker Hub ä»“åº“æ˜¯å¦å­˜åœ¨:"
          echo "https://hub.docker.com/r/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}"

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}  # GitHub Secrets ä¸­çš„ç”¨æˆ·å
          password: ${{ secrets.DOCKER_HUB_TOKEN }}     # GitHub Secrets ä¸­çš„ä»¤ç‰Œ

      - name: Verify login and permissions
        run: |
          echo "éªŒè¯ Docker Hub ç™»å½•çŠ¶æ€..."
          # æµ‹è¯•æ¨é€æƒé™
          docker pull alpine:latest
          docker tag alpine:latest ${{ env.DOCKER_USERNAME }}/test-verify:latest
          
          echo "å°è¯•æ¨é€æµ‹è¯•é•œåƒ..."
          if docker push ${{ env.DOCKER_USERNAME }}/test-verify:latest 2>&1 | grep -q "denied"; then
            echo "âŒ æ¨é€æƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥ï¼š"
            echo "1. Docker Hub Token æ˜¯å¦æœ‰ write æƒé™"
            echo "2. ä»“åº“ ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }} æ˜¯å¦å­˜åœ¨"
            exit 1
          else
            echo "âœ… æ¨é€æƒé™éªŒè¯é€šè¿‡"
            # æ¸…ç†æµ‹è¯•é•œåƒ
            docker rmi ${{ env.DOCKER_USERNAME }}/test-verify:latest || true
          fi

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        id: build-push
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.run_number }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NPM_REGISTRY=https://registry.npmmirror.com
            PNPM_FLAGS=--store-dir=/tmp/pnpm-store
          provenance: false
          sbom: false

      - name: Verify image on Docker Hub
        run: |
          echo "éªŒè¯é•œåƒæ˜¯å¦å·²æ¨é€åˆ° Docker Hub..."
          echo "ç­‰å¾… 5 ç§’è®© Docker Hub å¤„ç†..."
          sleep 5
          
          echo "ğŸ“¦ é•œåƒæ¨é€å®Œæˆï¼"
          echo ""
          echo "âœ… é•œåƒåœ°å€ï¼š"
          echo "   docker pull ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
          echo "   docker pull ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo ""
          echo "ğŸŒ åœ¨ Docker Hub æŸ¥çœ‹ï¼š"
          echo "   https://hub.docker.com/r/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}"
          echo "   https://hub.docker.com/r/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}/tags"
          echo ""
          echo "ğŸ’¡ æç¤ºï¼šDocker Hub ç•Œé¢å¯èƒ½éœ€è¦ 1-2 åˆ†é’Ÿåˆ·æ–°æ˜¾ç¤º"

      - name: Manual verification instructions
        if: always()
        run: |
          echo "ğŸ” å¦‚æœ Docker Hub ç•Œé¢çœ‹ä¸åˆ°é•œåƒï¼Œè¯·å°è¯•ï¼š"
          echo ""
          echo "1. å‘½ä»¤è¡ŒéªŒè¯ï¼š"
          echo "   docker pull ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "2. ç›´æ¥è®¿é—® APIï¼š"
          echo "   curl -s 'https://hub.docker.com/v2/repositories/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}/tags/' | jq ."
          echo ""
          echo "3. æ£€æŸ¥æ˜¯å¦åˆ›å»ºäº†ä»“åº“ï¼š"
          echo "   è®¿é—®ï¼šhttps://hub.docker.com/repository/create"
          echo "   ä»“åº“åå¡«å†™ï¼šxianyu-auto-reply"
          echo "   å¯è§æ€§é€‰æ‹©ï¼šPublic"
