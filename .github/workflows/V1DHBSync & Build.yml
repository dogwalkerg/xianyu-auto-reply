name: V1DHBSync & Build

on:
  workflow_dispatch:
    inputs:
      force_build:
        description: 'å¼ºåˆ¶æ„å»ºé•œåƒ'
        required: false
        type: boolean
        default: false
      version_tag:
        description: 'v1.0.5ï¼‰'
        required: false
        default: ''
  schedule:
    - cron: '0 3 * * *'
    - cron: '0 10 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.changes_detected || inputs.force_build }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@users.noreply.github.com"

      - name: Get current date
        id: date
        run: |
          echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
          echo "datetime=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Sync Upstream
        id: check
        run: |
          git remote add upstream https://github.com/zhinianboke/xianyu-auto-reply.git || true
          git fetch upstream
          
          if [ "${{ github.event.inputs.force_build }}" = "true" ] || [ -n "${{ github.event.inputs.version_tag }}" ]; then
            echo "ğŸŸ¡ æ‰‹åŠ¨è§¦å‘æ„å»ºæ¨¡å¼"
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          elif ! git diff --quiet HEAD upstream/main; then
            echo "ğŸ”µ æ£€æµ‹åˆ°ä¸Šæ¸¸å˜æ›´"
            git merge -X theirs upstream/main
            git push origin main
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸŸ¢ æ— æ–°å˜æ›´"
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi

  build:
    needs: sync
    if: needs.sync.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      DOCKER_USERNAME: "bbrplus"
      IMAGE_NAME: "xianyu-auto-reply"
      # ç‰ˆæœ¬ç­–ç•¥
      VERSION_TAG: ${{ github.event.inputs.version_tag || 'latest' }}
      DATE_TAG: ${{ needs.sync.outputs.date || 'nodate' }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show build info
        run: |
          echo "ğŸ¯ æ„å»ºé…ç½®ä¿¡æ¯ï¼š"
          echo "Docker Hub ç”¨æˆ·å: ${{ env.DOCKER_USERNAME }}"
          echo "é•œåƒåç§°: ${{ env.IMAGE_NAME }}"
          echo "ç‰ˆæœ¬æ ‡ç­¾: ${{ env.VERSION_TAG }}"
          echo "æ—¥æœŸæ ‡ç­¾: ${{ env.DATE_TAG }}"
          echo "Git SHA: ${{ github.sha }}"
          echo "è¿è¡Œç¼–å·: ${{ github.run_number }}"
          echo ""
          echo "ğŸ“Š Docker Hub ä»“åº“:"
          echo "https://hub.docker.com/r/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}"

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        id: build-push
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            # ä¸»è¦æ ‡ç­¾
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.VERSION_TAG }}
            
            # å›ºå®šç‰ˆæœ¬æ ‡ç­¾ï¼ˆæ¨èä½¿ç”¨ï¼‰
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:v1.0.4
            
            # ç‰¹å®šæ ‡è¯†æ ‡ç­¾
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.DATE_TAG }}
            
            # è¿è¡Œç¼–å·æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:run-${{ github.run_number }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            org.opencontainers.image.version=${{ env.VERSION_TAG }}
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NPM_REGISTRY=https://registry.npmmirror.com
            PNPM_FLAGS=--store-dir=/tmp/pnpm-store
            VERSION=${{ env.VERSION_TAG }}
          provenance: false
          sbom: false

      - name: Clean old tags (optional)
        run: |
          echo "å¦‚æœéœ€è¦æ¸…ç†æ—§æ ‡ç­¾ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ¸…ç†é€»è¾‘"
          echo "å½“å‰æ ‡ç­¾å·²æ¨é€ï¼š"
          echo "1. latest"
          echo "2. ${{ env.VERSION_TAG }}"
          echo "3. v1.0.4"
          echo "4. ${{ github.sha }}"
          echo "5. ${{ env.DATE_TAG }}"
          echo "6. run-${{ github.run_number }}"

      - name: Display verification info
        run: |
          echo "=========================================="
          echo "âœ… Docker é•œåƒæ„å»ºå’Œæ¨é€å®Œæˆï¼"
          echo ""
          echo "ğŸ“¦ å¯ç”¨çš„é•œåƒæ ‡ç­¾ï¼š"
          echo ""
          echo "   æœ€æ–°ç‰ˆæœ¬:"
          echo "   docker pull ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "   å›ºå®šç‰ˆæœ¬ (æ¨èç”Ÿäº§ä½¿ç”¨):"
          echo "   docker pull ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:v1.0.4"
          echo ""
          echo "   ç‰¹å®šæäº¤ç‰ˆæœ¬:"
          echo "   docker pull ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo ""
          echo "   ä»Šæ—¥æ„å»ºç‰ˆæœ¬:"
          echo "   docker pull ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.DATE_TAG }}"
          echo ""
          echo "ğŸŒ åœ¨ Docker Hub æŸ¥çœ‹æ‰€æœ‰æ ‡ç­¾ï¼š"
          echo "   https://hub.docker.com/r/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}/tags"
          echo ""
          echo "ğŸ” éªŒè¯å‘½ä»¤ï¼š"
          echo "   # æŸ¥çœ‹æ‰€æœ‰æ ‡ç­¾"
          echo "   curl -s 'https://hub.docker.com/v2/repositories/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}/tags/' | jq '.results[].name'"
          echo ""
          echo "   # æ‹‰å–æµ‹è¯•"
          echo "   docker pull ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:v1.0.5"
          echo "=========================================="
